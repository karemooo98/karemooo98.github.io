<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>لوحة تحكم المدير</title>
  <style>
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      background: #f4f4f4; 
      margin: 0; 
      direction: rtl;
      text-align: right;
    }
    nav { 
      background: #3f51b5; 
      color: white; 
      padding: 15px 30px; 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
    }
    nav button { 
      background: none; 
      border: none; 
      color: white; 
      font-weight: bold; 
      cursor: pointer; 
      font-size: 16px;
    }
    main { 
      max-width: 900px; 
      margin: 20px auto; 
      background: white; 
      padding: 30px; 
      border-radius: 10px; 
      box-shadow: 0 0 10px rgba(0,0,0,0.1); 
    }
    input, select, button, textarea {
      width: 100%;
      padding: 12px;
      margin-top: 10px;
      font-size: 16px;
      border-radius: 8px;
      border: 1px solid #ccc;
      box-sizing: border-box;
      font-family: inherit;
      text-align: right;
    }
    button {
      background: #3f51b5; 
      color: white; 
      border: none; 
      border-radius: 8px; 
      cursor: pointer;
      font-weight: bold;
      transition: background-color 0.3s ease;
    }
    button:hover {
      background: #303f9f;
    }
    h2 {
      margin-bottom: 20px;
      font-weight: bold;
      color: #3f51b5;
      text-align: right;
    }
    table { 
      width: 100%; 
      border-collapse: collapse; 
      margin-top: 20px; 
    }
    th, td { 
      border: 1px solid #ccc; 
      padding: 10px; 
      text-align: right; 
      font-size: 14px;
    }
    th { 
      background: #f1f1f1; 
    }
    .serial-button {
      background-color: #1976d2;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      transition: background-color 0.3s ease;
    }
    .serial-button:hover {
      background-color: #115293;
    }
  </style>
</head>
<body>
  <nav>
    <div>المدير: <span id="adminName"></span></div>
    <button onclick="logout()">تسجيل خروج</button>
  </nav>

  <main>
    <h2>إضافة موظف أو مدير</h2>
    <input type="text" id="empName" placeholder="الاسم الكامل" />
    <input type="text" id="empId" placeholder="اسم المستخدم" />
    <input type="password" id="empPass" placeholder="كلمة المرور" />
    <select id="empRole">
      <option value="employee">موظف</option>
      <option value="admin">مدير</option>
    </select>
    <button onclick="addEmployee()">إضافة مستخدم</button>

    <h2>قائمة الموظفين</h2>
    <div id="employeesList">جار التحميل...</div>

    <h2>عرض تسجيلات الموظفين</h2>
    <select id="employeeSelect" onchange="loadEmployeeSubmissions()">
      <option value="">-- اختر موظف --</option>
    </select>

    <div id="employeeSubmissions" style="margin-top:20px;">اختر موظفًا لعرض تسجيلاته.</div>
  </main>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyD5NdcVxl1m77m4PBGaU9PL3jqvLtfJL9I",
      authDomain: "pos-web-3ca21.firebaseapp.com",
      projectId: "pos-web-3ca21",
      storageBucket: "pos-web-3ca21.firebasestorage.app",
      messagingSenderId: "163092162625",
      appId: "1:163092162625:web:eeef79875a66d327de3ec0",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const role = localStorage.getItem("role");
    const adminName = localStorage.getItem("employeeName");
    if (role !== "admin") {
      alert("تم رفض الدخول. الرجاء تسجيل الدخول كمدير.");
      window.location.href = "login.html";
    }
    document.getElementById("adminName").textContent = adminName || "المدير";

    function logout() {
      localStorage.clear();
      window.location.href = "login.html";
    }

    function addEmployee() {
      const name = document.getElementById("empName").value.trim();
      const id = document.getElementById("empId").value.trim();
      const pass = document.getElementById("empPass").value;
      const userRole = document.getElementById("empRole").value;

      if (!name || !id || !pass) {
        alert("يرجى ملء جميع الحقول.");
        return;
      }

      db.collection("employees").doc(id).set({
        id,
        name,
        password: pass,
        role: userRole
      })
      .then(() => {
        alert("تمت إضافة المستخدم بنجاح.");
        document.getElementById("empName").value = "";
        document.getElementById("empId").value = "";
        document.getElementById("empPass").value = "";
        loadEmployees();
      })
      .catch(err => {
        alert("حدث خطأ أثناء الإضافة: " + err.message);
      });
    }

    function loadEmployees() {
      db.collection("employees").where("role", "==", "employee").get()
        .then(snapshot => {
          const select = document.getElementById("employeeSelect");
          select.innerHTML = '<option value="">-- اختر موظف --</option>';

          if (snapshot.empty) {
            document.getElementById("employeesList").textContent = "لا يوجد موظفين.";
            return;
          }
          let html = `<table>
            <thead><tr><th>اسم المستخدم</th><th>الاسم</th><th>الدور</th><th>حذف</th></tr></thead><tbody>`;
          snapshot.forEach(doc => {
            const d = doc.data();
            html += `<tr>
              <td>${d.id}</td>
              <td>${d.name}</td>
              <td>${d.role === "admin" ? "مدير" : "موظف"}</td>
              <td><button onclick="deleteEmployee('${d.id}')">حذف</button></td>
            </tr>`;

            const option = document.createElement("option");
            option.value = d.id;
            option.textContent = `${d.name} (${d.id})`;
            select.appendChild(option);
          });
          html += `</tbody></table>`;
          document.getElementById("employeesList").innerHTML = html;
        });
    }

    function deleteEmployee(empId) {
      if (!confirm("هل أنت متأكد من حذف المستخدم " + empId + "؟")) return;
      db.collection("employees").doc(empId).delete()
        .then(() => {
          alert("تم حذف المستخدم.");
          loadEmployees();
          document.getElementById("employeeSubmissions").textContent = "اختر موظفًا لعرض تسجيلاته.";
        });
    }

    function loadEmployeeSubmissions() {
      const empId = document.getElementById("employeeSelect").value;
      if (!empId) {
        document.getElementById("employeeSubmissions").textContent = "اختر موظفًا لعرض تسجيلاته.";
        return;
      }

      db.collection("device_submissions")
        .where("employeeId", "==", empId)
        .orderBy("date", "desc")
        .get()
        .then(snapshot => {
          if (snapshot.empty) {
            document.getElementById("employeeSubmissions").textContent = "لا توجد تسجيلات لهذا الموظف.";
            return;
          }

          let totalDevices = 0;
          let totalFaulty = 0;

          let html = `<table>
            <thead><tr>
              <th>التاريخ</th>
              <th>نوع الجهاز</th>
              <th>العدد</th>
              <th>أرقام السيريال</th>
              <th>الأجهزة المعطوبة</th>
              <th>ملاحظات</th>
            </tr></thead><tbody>`;

          snapshot.forEach(doc => {
            const d = doc.data();
            const date = d.date && d.date.toDate ? d.date.toDate().toLocaleString('ar-EG') : "غير متوفر";
            const serials = d.serialNumbers || "-";
            const deviceCount = d.deviceCount || 0;
            const faultyCount = d.faultyCount || 0;

            totalDevices += deviceCount;
            totalFaulty += faultyCount;

            html += `<tr>
              <td>${date}</td>
              <td>${d.deviceType || "-"}</td>
              <td>${deviceCount}</td>
              <td><button class="serial-button" data-serials="${encodeURIComponent(serials)}">عرض</button></td>
              <td>${faultyCount}</td>
              <td>${d.notes || "-"}</td>
            </tr>`;
          });

          html += `<tr style="font-weight:bold; background:#f9f9f9;">
            <td colspan="2">الإجمالي</td>
            <td>${totalDevices}</td>
            <td></td>
            <td>${totalFaulty}</td>
            <td></td>
          </tr>`;

          html += "</tbody></table>";
          document.getElementById("employeeSubmissions").innerHTML = html;

          document.querySelectorAll(".serial-button").forEach(btn => {
            btn.addEventListener("click", () => {
              const serialsDecoded = decodeURIComponent(btn.getAttribute("data-serials"));
              showSerials(serialsDecoded);
            });
          });
        })
        .catch(err => {
          console.error(err);
          document.getElementById("employeeSubmissions").textContent = "حدث خطأ أثناء تحميل التسجيلات.";
        });
    }

    function showSerials(serials) {
      const modal = document.createElement("div");
      modal.id = "serialModal";
      modal.style.position = "fixed";
      modal.style.top = "0";
      modal.style.left = "0";
      modal.style.width = "100%";
      modal.style.height = "100%";
      modal.style.backgroundColor = "rgba(0, 0, 0, 0.6)";
      modal.style.display = "flex";
      modal.style.justifyContent = "center";
      modal.style.alignItems = "center";
      modal.style.zIndex = "9999";

      const formattedSerials = serials.split(",").map(s => s.trim()).join("<br>");

      modal.innerHTML = `
        <div style="background:white; padding:20px; border-radius:10px; max-width:500px; max-height:80%; overflow:auto; direction: rtl; text-align: right;">
          <h3>أرقام السيريال</h3>
          <div style="font-family: monospace; line-height: 1.5;">${formattedSerials || "-"}</div>
          <br>
          <button onclick="document.body.removeChild(document.getElementById('serialModal'))"
            style="margin-top:10px; padding:8px 16px; font-weight:bold; border-radius: 6px; border:none; background:#3f51b5; color:white; cursor:pointer;">إغلاق</button>
        </div>
      `;

      document.body.appendChild(modal);
    }

    window.onload = loadEmployees;
  </script>
</body>
</html>
